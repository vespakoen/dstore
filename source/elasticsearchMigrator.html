<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">&quot;use strict&quot;;

var _ = require('underscore');
var BBPromise = require('bluebird');
var help = require('../helpers');

<span id='elasticsearch-ElasticsearchMigrator'>/**
</span> * @class elasticsearch.ElasticsearchMigrator
 * ElasticsearchMigrator
 *
 * @param {elasticsearch.ElasticsearchClient} client
 * @param {schema.SchemaAdapter} schemaAdapter
 */
function ElasticsearchMigrator(client, schemaAdapter) {
  this.client = client;
  this.schemaAdapter = schemaAdapter;
}

<span id='elasticsearch-ElasticsearchMigrator-property-attachKey'>/**
</span> * IOC attachKey
 *
 * @type {String}
 */
ElasticsearchMigrator.attachKey = 'elasticsearch.migrator';

<span id='elasticsearch-ElasticsearchMigrator-method-attach'>/**
</span> * IOC attach
 *
 * @param {App} app
 *
 * @return {BBPromise|Object} The object with resolved dependencies
 */
ElasticsearchMigrator.attach = function(app) {
  return BBPromise.join(
    app.get('elasticsearch.client'),
    app.get('schema.adapter')
  ).spread(function(client, schemaAdapter) {
    return new ElasticsearchMigrator(client, schemaAdapter);
  });
};

<span id='elasticsearch-ElasticsearchMigrator-method-migrate'>/**
</span> * Create a new elasticsearch index version and put the mapping.
 *
 * @param  {String} namespace
 * @param  {Number} version
 *
 * @return {BBPromise.&lt;undefined&gt;}
 */
ElasticsearchMigrator.prototype.migrate = function(namespace, version) {
  var self = this;
  var opts = {
    index: namespace + 'v' + version
  };

  var schemaClient = this.schemaAdapter.getClient(namespace);
  return schemaClient.getSnapshot(version)
    .then(function (schemas) {
      opts.schemas = schemas;
      return self._createIndex(opts);
    })
    .then(function () {
      return self._putMapping(opts);
    });
};

<span id='elasticsearch-ElasticsearchMigrator-method-_createIndex'>/**
</span> * Create a new elasticsearch index.
 *
 * @protected
 * @param opts
 * @param opts.index The name of the index to create
 *
 * @return {BBPromise.&lt;undefined&gt;}
 */
ElasticsearchMigrator.prototype._createIndex = function(opts) {
  var self = this;

  return self.client.indices.exists({
    index: opts.index
  })
  .then(function(exists) {
    if (!exists) {
      return self.client.indices.create({
        index: opts.index
      });
    }
  });
};

<span id='elasticsearch-ElasticsearchMigrator-method-_putMapping'>/**
</span> * Create and put a mapping.
 *
 * @protected
 * @param opts
 * @param opts.schemas  The schemas to turn into a mapping
 * @param opts.index    The index to put the mapping to
 *
 * @return {BBPromise.&lt;undefined&gt;}
 */
ElasticsearchMigrator.prototype._putMapping = function (opts) {
  var self = this;

  var promises = _.map(opts.schemas, function(schema, schemaKey) {
    var mapping = {};

    mapping[schemaKey] = {
      _id: {path: 'id'},
      properties: {}
    };

    _.each(schema.columns, function(column, columnKey) {
      self['_define' + help.capitalizeFirstLetter(column.type)](mapping, schemaKey, column, columnKey);

      // if extra options are given for elasticsearch, mix them in
      if (column.elasticsearch) {
        _.extend(mapping[schemaKey].properties[columnKey], column.elasticsearch);
      }
    });

    return this.client.indices.putMapping({
      index: opts.index,
      type: schemaKey,
      body: mapping
    });
  }, this);

  return BBPromise.all(promises);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineUuid'>/**
</span> * Define a uuid mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineUuid = function (mapping, schemaKey, column, columnKey) {
  return this._defineString(mapping, schemaKey, column, columnKey);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineText'>/**
</span> * Define a text mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineText = function (mapping, schemaKey, column, columnKey) {
  return this._defineString(mapping, schemaKey, column, columnKey);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineString'>/**
</span> * Define a string mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineString = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'string',
    index: 'not_analyzed'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_definePoint'>/**
</span> * Define a point mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._definePoint = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'geo_point'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineLinestring'>/**
</span> * Define a linestring mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineLinestring = function (mapping, schemaKey, column, columnKey) {
  return this._defineShape(mapping, schemaKey, column, columnKey);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineRectangle'>/**
</span> * Define a rectangle mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineRectangle = function (mapping, schemaKey, column, columnKey) {
  return this._defineShape(mapping, schemaKey, column, columnKey);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_definePolygon'>/**
</span> * Define a polygon mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._definePolygon = function (mapping, schemaKey, column, columnKey) {
  return this._defineShape(mapping, schemaKey, column, columnKey);
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineShape'>/**
</span> * Define a shape mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineShape = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'geo_shape',
    tree: 'quadtree',
    precision: '10m'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineDate'>/**
</span> * Define a date mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineDate = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'date',
    format: 'yyyy-MM-dd'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineDatetime'>/**
</span> * Define a datetime mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineDatetime = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'date',
    format: 'yyyy-MM-dd HH:mm:ss'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineFloat'>/**
</span> * Define a float mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineFloat = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'float'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineInteger'>/**
</span> * Define a integer mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineInteger = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'integer'
  };
};

<span id='elasticsearch-ElasticsearchMigrator-method-_defineBoolean'>/**
</span> * Define a boolean mapping.
 *
 * @protected
 * @param  {Object} mapping
 * @param  {String} schemaKey
 * @param  {Object} column
 * @param  {String} columnKey
 */
ElasticsearchMigrator.prototype._defineBoolean = function (mapping, schemaKey, column, columnKey) {
  mapping[schemaKey].properties[columnKey] = {
    type: 'boolean'
  };
};

module.exports = ElasticsearchMigrator;
</pre>
</body>
</html>
