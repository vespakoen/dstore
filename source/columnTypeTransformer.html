<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">'use strict';

var _ = require('underscore');
var BBPromise = require('bluebird');
var geojsonCoords = require('geojson-coords');

<span id='storage-ColumnTypeTransformer'>/**
</span> * ColumnTypeTransformer
 * 
 * @class storage.ColumnTypeTransformer 
 */
function ColumnTypeTransformer() {}

<span id='storage-ColumnTypeTransformer-property-attachKey'>/**
</span> * IOC attachKey.
 *
 * @type {String}
 */
ColumnTypeTransformer.attachKey = 'storage.column.type.transformer';

<span id='storage-ColumnTypeTransformer-method-attach'>/**
</span> * IOC attach.
 *
 * @param {App} app
 *
 * @return {BBPromise} An ColumnTypeTransformer instance with resolved dependencies.
 */
ColumnTypeTransformer.attach = function (app) {
  return BBPromise.resolve(new ColumnTypeTransformer());
};

ColumnTypeTransformer.prototype.transform = function(value, fromType, toType) {
  // example input: fromType=string, toType=string[]
  // output: method=_transformToStringArray('integer[]', value)
  var method = '_transformTo' + help.capitalizeFirstLetter(toType.replace('[]', 'Array'));

  // null stays null
  if (value === null) {
    return null;
  }

  // same type stays same
  if (fromType === toType) {
    return value;
  }

  // call method when it exists
  if (this[method]) {
    return this[method](value, fromType);
  }

  // didn't manage to transform, return null
  return null;
};

<span id='storage-ColumnTypeTransformer-method-_transformToUuidArray'>/**
</span> * Transform value to a uuid array.
 * In this case we will simply stringify the best we can
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToUuidArray = function (value, fromType) {
  // uuid's can be converted to an array
  if (fromType === 'uuid') {
    return [value];
  }

  // the rest cannot be converted
  return null;
};

<span id='storage-ColumnTypeTransformer-method-_transformToString'>/**
</span> * Transform value to a string.
 * In this case we will simply stringify the best we can
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToString = function (value, fromType) {
  // stringify
  value = this._transformToText(value, fromType);

  // cut off if it's too much
  if (value.length &gt; 255) {
    return value.substring(0, 251) + ' ...';
  }

  return value;
};

<span id='storage-ColumnTypeTransformer-method-_transformToStringArray'>/**
</span> * Transform value to a string array.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToStringArray = function (value, fromType) {
  return _.map(this._transformToTextArray(value, fromType), function (value) {
    if (value.length &gt; 255) {
      return value.substring(0, 251) + ' ...';
    }
    return value;
  });
};

<span id='storage-ColumnTypeTransformer-method-_transformToText'>/**
</span> * Transform value to a text.
 * In this case we will simply stringify the best we can
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToText = function (value, fromType) { 
  if (_.isDate(value)) {
    return value.toString();
  }
  
  if (_.isObject(value) || _.isArray(value)) {
    return JSON.stringify(value);
  }

  return &quot;&quot; + value;
};


<span id='storage-ColumnTypeTransformer-method-_transformToTextArray'>/**
</span> * Transform value to a text array.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToTextArray = function (value, fromType) {
  switch (fromType) {
    // these can stay the same
    case 'uuid[]':
    case 'string[]':
      return value;

    // these will be stringified
    case 'date[]':
    case 'datetime[]':
    case 'float[]':
    case 'integer[]':
    case 'boolean[]':
    case 'json[]':
      return _.map(value, function (val) {
        return this._transformToText(value, fromType);
      }, this);

    // these will be stringified and be put as the first item in the array
    case 'point[]':
    case 'linestring[]':
    case 'polygon[]':
    case 'uuid':
    case 'string':
    case 'text':
    case 'point':
    case 'linestring':
    case 'polygon':
    case 'date':
    case 'datetime':
    case 'float':
    case 'integer':
    case 'boolean':
    case 'json':
      return [this._transformToText(value, fromType)];
  }
};

<span id='storage-ColumnTypeTransformer-method-_transformToPoint'>/**
</span> * Transform value to a point.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToPoint = function (value, fromType) {
  switch (fromType) {
    // we can get the center of these
    case 'linestring':
    case 'polygon':
    case 'point[]':
    case 'linestring[]':
    case 'polygon[]':
      return this._getCentroidPointOfGeoJson(value);
  }

  return null;
};

<span id='storage-ColumnTypeTransformer-method-_transformToPointArray'>/**
</span> * Transform value to a point array.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToPointArray = function (value, fromType) {
  switch (fromType) {
    // we can get the center of these
    case 'linestring':
    case 'polygon':
    case 'point[]':
    case 'linestring[]':
    case 'polygon[]':
      var point = this._getCentroidPointOfGeoJson(value);
      point.type = 'MultiPoint';
      point.coordinates = [point.coordinates];
      return point;
  }

  return null;
};

<span id='storage-ColumnTypeTransformer-method-_transformToDate'>/**
</span> * Transform value to a date.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToDate = function (value, fromType) {
  if (fromType === 'datetime') {
    return value.substring(0, 'yyyy-mm-dd'.length);
  }

  if (fromType === 'datetime[]' || fromType === 'date[]') {
    return value[0] ? value[0].substring(0, 'yyyy-mm-dd'.length) : null;
  }

  return null;
};

<span id='storage-ColumnTypeTransformer-method-_transformToDateArray'>/**
</span> * Transform value to a date.
 * 
 * @param  {*} value
 * @param  {String} fromType
 * @return {String}
 */
ColumnTypeTransformer.prototype._transformToDateArray = function (value, fromType) {
  if (fromType === 'datetime' || fromType === 'date') {
    return value.substring(0, 'yyyy-mm-dd'.length);
  }

  if (fromType === 'datetime[]') {
    return value[0] ? value[0].substring(0, 'yyyy-mm-dd'.length) : null;
  }

  return null;
};

ColumnTypeTransformer.prototype._getCentroidPointOfGeoJson = function (value) {
  var coords = geojsonCoords(value);

  var minX, minY, maxX, maxY = null;
  _.each(coords, function (coord) {
    if (minX === null || minX &gt; coord[0]) {
      minX = coord[0];
    }
    if (maxX === null || maxX &lt; coord[0]) {
      maxX = coord[0];
    }
    if (minY === null || minY &gt; coord[0]) {
      minY = coord[0];
    }
    if (maxY === null || maxY &lt; coord[0]) {
      maxY = coord[0];
    }
  });

  return {
    &quot;type&quot;: &quot;Point&quot;,
    &quot;coordinates&quot;: [(minX + maxX) / 2, (minY + maxY) / 2]
  };
};

module.exports = ColumnTypeTransformer;
</pre>
</body>
</html>
