<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">'use strict';

var _ = require('underscore');
var pg = require('pg');
var help = require('../../helpers');
var BBPromise = require('bluebird');
BBPromise.promisifyAll(pg);

<span id='storage-postgresql-PostgresqlMigrator'>/**
</span> * PostgresqlMigrator
 * 
 * @class storage.postgresql.PostgresqlMigrator
 * 
 * @param {Object} config
 * @param {storage.postgresql.PostgresqlAdapter} adapter
 */
function PostgresqlMigrator(config, adapter) {
  this.config = config;
  this.adapter = adapter;
}

<span id='storage-postgresql-PostgresqlMigrator-property-attachKey'>/**
</span> * IOC attachKey.
 *
 * @type {String}
 */
PostgresqlMigrator.attachKey = 'storage.postgresql.migrator';

<span id='storage-postgresql-PostgresqlMigrator-method-attach'>/**
</span> * IOC attach.
 *
 * @param {App} app
 * @return {BBPromise} A PostgresqlMigrator instance with resolved dependencies
 */
PostgresqlMigrator.attach = function(app) {
  var config = app.config.postgresql;
  return app.get('storage.postgresql.adapter')
    .then(function(adapter) {
      return new PostgresqlMigrator(config, adapter);
    });
};

<span id='storage-postgresql-PostgresqlMigrator-method-migrate'>/**
</span> * Create / migrate database.
 *
 * @param  {String} projectId
 * @param  {Number} projectVersion
 *
 * @return {BBPromise.&lt;undefined&gt;}
 */
PostgresqlMigrator.prototype.migrate = function(projectId, projectVersion, blueprints) {
  var self = this;
  var opts = {
    projectId: projectId,
    projectVersion: projectVersion,
    connectionString: 'postgresql://' + this.config.username + ':' + this.config.password + '@' + this.config.host + '/postgres',
    blueprints: blueprints
  };

  return self._getConnection(opts)
    .then(function (managementClient) {
      opts.managementClient = managementClient;
      return self._createDatabase(opts)
        .then(function () {
          return self._getDatabaseClient(opts);
        })
        .then(function (client) {
          opts.client = client;
          return self._createTables(opts);
        });
    });
};

PostgresqlMigrator.prototype._getConnection = function (opts) {
  var self = this;
  return pg.connectAsync(opts.connectionString)
    .spread(function(client, done) {
      self.connectionCloser = done;
      return client;
    });
};

PostgresqlMigrator.prototype.closeConnection = function () {
  if (this.connectionCloser) {
    this.connectionCloser();
  }
};

<span id='storage-postgresql-PostgresqlMigrator-method-_createDatabase'>/**
</span> * Creates a new database for given projectId and project version.
 * 
 * @param  {Object} opts                  Options for creating the DATABASE
 * @param  {String} opts.connectionString The postgresql connectionstring
 * @param  {String} opts.projectId        The project's identifier
 * @param  {Number} opts.projectVersion   The project version
 */
PostgresqlMigrator.prototype._createDatabase = function(opts) {
  return opts.managementClient.queryAsync('CREATE DATABASE ' + opts.projectId + 'v' + opts.projectVersion + ' TEMPLATE=template_postgis')
    .catch(function (err) {
      console.error('Error while creating database', err);
      throw err;
    });
};

<span id='storage-postgresql-PostgresqlMigrator-method-_getDatabaseClient'>/**
</span> * Retrieves the database client for given projectId and project version.
 * 
 * @param  {Object} opts                    Options for retrieving the database
 * @param  {String} opts.projectId          The project's identifier
 * @param  {Number} opts.projectVersion     The project version
 */
PostgresqlMigrator.prototype._getDatabaseClient = function(opts) {
  return this.adapter.getClient(opts.projectId, opts.projectVersion);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_createTables'>/**
</span> * Creates tables in database based on the given blueprints.
 * 
 * @param  {Object}                                 opts            Options for creating the tables
 * @param  {projector.postgresql.PostgresqlClient}  opts.client     The project's identifier
 * @param  {Object}                                 opts.blueprints The blueprints
 */
PostgresqlMigrator.prototype._createTables = function(opts) {
  var self = this;

  var promises = _.map(opts.blueprints, function(blueprint, blueprintId) {
    return opts.client.schema.createTable(blueprint.postgresql.table, function(table) {
      table.uuid('id').primary();
      table.integer('project_version');
      _.each(blueprint.columns, function(column, columnKey) {
        self['_define' + help.capitalizeFirstLetter(column.type).replace('[]', 'Array')](table, column, columnKey);
      });
      table.specificType('links', 'uuid[]');
    })
    // triger knex.js's promise strategy
    .then(function() {
    }, function (err) {
      console.error('error while creating tables', err);
    });
  });

  return BBPromise.all(promises);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineInteger'>/**
</span> * Defines an INTEGER column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineInteger = function(table, column, columnKey) {
  table.integer(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineIntegerArray'>/**
</span> * Defines an INTEGER[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineIntegerArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'INTEGER[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineUuid'>/**
</span> * Defines an UUID column on given table.
 * 
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineUuid = function(table, column, columnKey) {
  table.uuid(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineUuidArray'>/**
</span> * Defines an UUID[] column on given table.
 * 
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineUuidArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'UUID[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineString'>/**
</span> * Defines an STRING column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineString = function(table, column, columnKey) {
  table.string(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineStringArray'>/**
</span> * Defines an STRING[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineStringArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'VARCHAR[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineText'>/**
</span> * Defines an TEXT column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineText = function(table, column, columnKey) {
  table.text(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineTextArray'>/**
</span> * Defines an TEXT[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineTextArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'TEXT[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineDatetime'>/**
</span> * Defines an DATETIME column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineDatetime = function(table, column, columnKey) {
  table.dateTime(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineDatetimeArray'>/**
</span> * Defines an DATETIME[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineDatetimeArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'TIMESTAMP WITH TIME ZONE[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineDate'>/**
</span> * Defines an DATE column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineDate = function(table, column, columnKey) {
  table.date(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineDateArray'>/**
</span> * Defines an DATE[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineDateArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'DATE[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineFloat'>/**
</span> * Defines an REAL column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineFloat = function(table, column, columnKey) {
  table.float(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineFloatArray'>/**
</span> * Defines an REAL[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineFloatArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'REAL[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_definePoint'>/**
</span> * Defines an GEOMETRY column of type Point on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._definePoint = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(Point,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_definePointArray'>/**
</span> * Defines an GEOMETRY column of type MultiPoint on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._definePointArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(MultiPoint,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineLinestring'>/**
</span> * Defines an GEOMETRY column of type LineString on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineLinestring = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(LineString,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineLinestringArray'>/**
</span> * Defines an GEOMETRY column of type MultiLineString on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineLinestringArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(MultiLineString,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_definePolygon'>/**
</span> * Defines an GEOMETRY column of type Polygon on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._definePolygon = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(Polygon,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_definePolygonArray'>/**
</span> * Defines an GEOMETRY column of type MultiPolygon on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._definePolygonArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'geometry(MultiPolygon,4326)');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineBoolean'>/**
</span> * Defines an BOOLEAN column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineBoolean = function(table, column, columnKey) {
  table.boolean(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineBooleanArray'>/**
</span> * Defines an BOOLEAN[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineBooleanArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'BOOLEAN[]');
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineJson'>/**
</span> * Defines a JSON column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineJson = function(table, column, columnKey) {
  table.json(columnKey);
};

<span id='storage-postgresql-PostgresqlMigrator-method-_defineJsonArray'>/**
</span> * Defines a JSON[] column on given table.
 *
 * @protected
 * @param  {Object} table     Knex.js table object (given through createTable's callback)
 * @param  {Object} column    Column definition
 * @param  {String} columnKey Name of the column
 */
PostgresqlMigrator.prototype._defineJsonArray = function(table, column, columnKey) {
  table.specificType(columnKey, 'JSON[]');
};

module.exports = PostgresqlMigrator;
</pre>
</body>
</html>
