<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">'use strict';

var fs = require('fs');
var _ = require('underscore');
var BBPromise = require('bluebird');

<span id='storage-ItemRepository'>/**
</span> * ItemRepository
 * 
 * @class storage.ItemRepository
 * 
 * @param {project.blueprint.BlueprintService}  blueprintService
 * @param {item.ItemTransformer}                itemTransformer
 * @param {Validator}                           validator
 */
function ItemRepository(blueprintService, itemTransformer, validator) {
  this.blueprintService = blueprintService;
  this.itemTransformer = itemTransformer;
  this.validator = validator;
}

// ItemRepository.prototype.putItemForAllVersions = function (projectId, blueprintId, item) {
//   var self = this;

//   // make a copy of the item
//   item = _.clone(item);

//   // returns a promise that resolves when all callback generated promises are done
//   return this.blueprintService.forEveryVersionOfBlueprint(projectId, blueprintId, item.project_version, function (projectVersion, blueprintIdAtVersion) {
//     // transform the item to the given snapshot version
//     return self.itemTransformer.transform(projectId, blueprintId, item, projectVersion)
//       .then(function(item) {
//         return self.putItem(projectId, blueprintIdAtVersion, item);
//       });
//   });
// };

// ItemRepository.prototype.delItemForAllVersions = function (projectId, blueprintId, projectVersion, id) {
//   var self = this;

//   // returns a promise that resolves when all callback generated promises are done
//   return this.blueprintService.forEveryVersionOfBlueprint(projectId, blueprintId, projectVersion, function (projectVersion, blueprintIdAtVersion) {
//     return self.delItem(projectId, blueprintIdAtVersion, projectVersion, id);
//   });
// };

ItemRepository.prototype._validatePutItem = function (projectId, blueprintId, id, item) {
  var self = this;

  return new BBPromise(function(resolve, reject) {
    if (!projectId) {
      return reject(new Error('The \'projectId\' argument is required!'));
    }
    if (!blueprintId) {
      return reject(new Error('The \'blueprintId\' argument is required!'));
    }
    if (!id) {
      return reject(new Error('The \'id\' argument is required!'));
    }
    if (!item) {
      return reject(new Error('The \'item\' argument is required!'));
    }

    resolve(self.blueprintService.getBlueprint(projectId, blueprintId, item.project_version)
      .then(function (blueprint) {
        var schema = self.getSchemaFromBlueprint(blueprint, blueprintId);
        self.validator.addSchema(schema);

        var result = self.validator.validate(item, blueprintId);
        if ( ! result.valid) {
          throw result.err;
        }

        return blueprint;
      }));
  });
};

ItemRepository.prototype._validateDelItem = function (projectId, blueprintId, id) {
  return new BBPromise(function(resolve, reject) {
    if (!projectId) {
      return reject(new Error('The \'projectId\' argument is required!'));
    }
    if (!blueprintId) {
      return reject(new Error('The \'blueprintId\' argument is required!'));
    }
    if (!id) {
      return reject(new Error('The \'id\' argument is required!'));
    }
    resolve();
  });
};

ItemRepository.prototype.getSchemaFromBlueprint = function (blueprint, blueprintId) {
  var properties = {};
  var required = [];

  _.each(blueprint.columns, function (column, columnKey) {
    var property = column.validation;
    if ( ! property) {
      property = { &quot;$ref&quot;: &quot;types#/definitions/&quot; + column.type };
    } else {
      if (property.required) {
        required.push(columnKey);
      }
    }

    if (column.nullable) {
      property = {
        anyOf: [
          property,
          { &quot;type&quot;: &quot;null&quot; }
        ]
      };
    }

    properties[columnKey] = property;
  });

  return {
    &quot;$schema&quot;: &quot;http://json-schema.org/draft-04/schema#&quot;,
    &quot;id&quot;: blueprintId,
    &quot;allOf&quot;: [
      { &quot;$ref&quot;: &quot;item&quot; },
      blueprint.validation ? blueprint.validation : {
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: properties,
        &quot;required&quot;: required
      } 
    ]
  };
};

module.exports = ItemRepository;
</pre>
</body>
</html>
